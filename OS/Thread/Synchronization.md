# 쓰레드 동기화 방법

1. 실행 순서의 동기화
   - 쓰레드의 실행순서를 정의하고, 이 순서에 반드시 따르도록 하는 것 입니다. 
2. 메모리 접근에 대한 동기화
   - 메모리 접근에 있어서 동시접근을 막는 것입니다. 
   - 실행의 순서가 중요한 상황이 아니고, 한 순간에 하나의 쓰레드만 접근하면 되는 상황을 의미합니다. 



# 동기화 기법의 종류

Windows에서 제공하는 동기화 기법은 제공하는 주체에 따라 크게 두 가지로 나뉩니다. 



## 유저 모드 동기화

동기화가 진행되는 과정에서 커널 코드가 실행되지 않는 동기화 기법입니다. 동기화를 위해서 커널 모드로의 전환이 불필요하기 때문에 성능에 이점이 있습니다. 하지만 그만큼 기능상의 제한도 존재합니다. 크리티컬 섹션 기반의 동기화, 인터락 함수 기반의 동기화가 있습니다. 



## 커널 모드 동기화

커널에서 제공하는 동기화 기능을 활용하는 방법입니다. 동기화에 관련된 함수가 호출될 때마다 커널 모드로의 변경이 필요하고, 이는 성능의 저하로 이어집니다. 하지만 그만큼 유저 모드 동기화에서 제공하지 못하는 기능을 제공받을 수 있습니다. 뮤텍스(Mutex) 기반의 동기화, 세마포어(Semaphore) 기반의 동기화, Named Mutex 기반의 동기화, 이벤트(Event) 기반의 동기화가 있습니다. 





### 뮤텍스(Mutex)

뮤텍스는 Key에 해당하는 어떤 오브젝트가 있으며 이 오브젝트를 소유한 쓰레드, 프로세스만이 공유자원에 접근할 수 있습니다. 

![mutex1](https://github.com/Ahrang777/Ahrang777.github.io/assets/59478159/576e0e85-8d10-4c70-9068-16222b7fe512)

#### 과정

1. 1번 프로세스가 자원을 접근하기 위해 키를 점유합니다. 
2. 1번 프로세스는 키를 점유했기 때문에 공유 자원을 사용합니다. 
3. 2번 프로세스가 공유 자원을 사용하기를 원합니다. 
4. 2번 프로세스는 키를 점유하기 위해 대기합니다. 
5. 3번 프로세스 또한 공유 자원을 사용하기 위해 2번 프로세스 다음 순번으로 대기합니다. 
6. 1번 프로세스가 공유 자원을 다 사용하고 키를 반환합니다. 
7. 2번 프로세스는 대기하고 있다가 반환된 키를 점유하고 공유 자원을 사용합니다. 



### 세마포어(Semaphore)

공유 자원에 접근할 수 있는 최대 허용치 만큼 동시 사용자(쓰레드, 프로세스) 접근을 허용하게 합니다. 

![semaphore](https://github.com/Ahrang777/Ahrang777.github.io/assets/59478159/aba82eb1-113e-48e1-b6ca-618c0f9eefd0)

#### 과정

1. 공유 자원에 대한 최대 허용치를 정의(3으로 가정)
2. 1번 프로세스가 공유 자원에 접근합니다. 허용치는 2로 감소했습니다.
3. 2번 프로세스가 공유 자원에 접근합니다. 허용치는 1로 감소합니다. 
4. 3번 프로세스가 공유 자원에 접근합니다. 허용치는 0으로 감소합니다. 
5. 4번 프로세스가 공유 자원에 접근합니다. 허용치가 0이므로 대기합니다. 
6. 2번 프로세스가 공유 자원을 다 사용하였습니다. 허용치는 1로 증가합니다. 
7. 4번 프로세스가 대기 하다가 허용치가 1로 증가되어 공유 자원에 접근합니다. 허용치는 다시 0으로 감소하였습니다. 



### 뮤텍스와 세마포어의 차이

- 세마포어는 뮤텍스가 될 수 있지만, 뮤텍스는 세마포어가 될 수 없습니다. 
- 세마포어는 소유할 수 없으며, 뮤텍스는 소유할 수 있고 소유주가 그에 대한 책임을 가집니다. 
- 세마포어는 동기화 대상이 여러개 일 때 사용하고, 뮤텍스는 동기화 대상이 오직 하나일 때 사용합니다. 

쓰레드A, B가 있을 때, 쓰레드 A가 키를 얻었다면 쓰레드 A가 반환하는게 당연합니다. 하지만, 쓰레드 A가 키를 얻어 임계 영역 안에 있고 쓰레드 B는 임계영역 시작 전 지점에서 대기, 이 상태에서 쓰레드 A에 문제가 있어서 키를 반환하지 않고 종료되었다고 가정하겠습니다. 이 경우 OS가 쓰레드 A에 문제가 생겼음을 인지하고, 쓰레드 B에게 키를 전달합니다. 비정상 종료에 의해서 뮤텍스(키)의 반환이 제대로 이루어지지 않았으므로, 그 키를 OS가 다시 가져다가 쓰레드 B에게 가져다 주는 형식입니다. 뮤텍스에는 이런 소유 관점이 있지만 세마포어에는 없습니다. 세마포어는 키를 여러 개 가질 수 있습니다. 세마포어는 카운트 값을 기준으로 공유합니다. 따라서, 세마포어 카운트 값을 1 감소시키는 대상과 세마포어 카운트 값을 1 증가시키는 대상이 일치하지 않아도 문제가 발생하지 않습니다. 



참고

[동기화 객체의 종류](https://velog.io/@ragnarok_code/OS-%EB%8F%99%EA%B8%B0%ED%99%94-%EA%B0%9D%EC%B2%B4%EC%9D%98-%EC%A2%85%EB%A5%98)

[뮤텍스, 세마포어](https://velog.io/@ragnarok_code/OS-%EB%8F%99%EA%B8%B0%ED%99%94-%EA%B0%9D%EC%B2%B4%EC%9D%98-%EC%A2%85%EB%A5%98)
